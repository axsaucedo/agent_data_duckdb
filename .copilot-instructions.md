# Claude Code DuckDB Extension - Development Instructions

## Critical Caveats

### 1. JSONL File Handling - DANGER ZONE
**⚠️ NEVER print, cat, or view full JSONL files from copilot_raw/ or test/data/**

The JSONL conversation files can be **massive** (hundreds of MB). Incorrect commands will:
- Pollute the entire context window
- Cause memory issues
- Result in incomplete/corrupted output

**Safe Commands:**
```bash
# View first N bytes only
head -c 500 file.jsonl

# Count lines without reading content
wc -l file.jsonl

# Get first N complete JSON lines
head -n 3 file.jsonl | jq -c '.'

# Sample specific fields only
head -n 10 file.jsonl | jq -c '{type, timestamp}'

# Get file size
ls -lh file.jsonl
```

**NEVER DO:**
```bash
cat file.jsonl           # DANGEROUS
less file.jsonl          # DANGEROUS (without limits)
jq '.' file.jsonl        # DANGEROUS (reads entire file)
```

### 2. Build Artifacts Location
- All temporary files go in `./tmp/` (not `/tmp/`)
- Build outputs go in `claude_code_ext/build/`
- Never create files requiring sudo

### 3. Testing Strategy
- Always run tests with limited data first
- Use `test/data/` synthetic data, not `copilot_raw/`
- Verify incrementally, not all at once

## Project Structure

```
agentic-copilot/
├── .copilot-instructions.md  # THIS FILE
├── docs/
│   ├── CLAUDE_FILE_STRUCTURE.md
│   └── CLAUDE_FILE_SCHEMAS.md
├── scripts/
│   ├── analyze_structure.py
│   ├── generate_test_data.py
│   └── verify.sh
├── test/
│   ├── data/                 # Synthetic ~/.claude mock
│   └── sql/                  # SQL test queries
├── claude_code_ext/          # DuckDB C API extension
│   ├── src/
│   ├── CMakeLists.txt
│   └── build/
└── copilot_raw/              # Real data - READ ONLY, HANDLE WITH CARE
```

## Extension Development

### Building
```bash
cd claude_code_ext
mkdir -p build && cd build
cmake -DEXTENSION_NAME=claude_code_ext ..
make -j$(nproc)
```

### Testing
```bash
# Run verification script
./scripts/verify.sh

# Manual DuckDB test
duckdb -cmd "LOAD 'claude_code_ext/build/claude_code_ext.duckdb_extension'; SELECT * FROM read_claude_conversations('test/data/');"
```

## Key Data Types

| Data Type | Location | Format | Notes |
|-----------|----------|--------|-------|
| Conversations | projects/\<proj\>/\<id\>.jsonl | JSONL | Large files |
| Plans | plans/\<name\>.md | Markdown | Text |
| Todos | todos/\<session\>-\<agent\>.json | JSON | Array |
| History | history.jsonl | JSONL | Command log |
| Stats | stats-cache.json | JSON | Aggregated |

## Verification Checklist

Before committing:
- [ ] All tests pass
- [ ] No large files accidentally committed
- [ ] Build artifacts excluded from git
- [ ] Documentation updated
